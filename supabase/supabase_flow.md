# Supabase ë§ˆì´ê·¸ë ˆì´ì…˜ ìš´ì˜ ê°€ì´ë“œ (ê¶Œì¥ FLOW)

ì´ ë¬¸ì„œëŠ” **Supabase + Postgres** í™˜ê²½ì—ì„œ  
`supabase/migrations` í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ê´€ë¦¬í•˜ëŠ” **ê¶Œì¥ í”Œë¡œìš°** ì •ë¦¬ë‹¤.

í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ë”± í•˜ë‚˜:

> **â€œDBë¥¼ ì§ì ‘ ë§Œì§€ì§€ ë§ê³ , ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ì†ŒìŠ¤ ì½”ë“œì²˜ëŸ¼ ê´€ë¦¬í•˜ì.â€**  
> â†’ SQL íŒŒì¼ â†’ ë¡œì»¬ DB â†’ í…ŒìŠ¤íŠ¸ â†’ ë³¸ ì„œë²„(DB) ìˆœìœ¼ë¡œë§Œ í˜ëŸ¬ê°€ê²Œ.

---

## 0. êµ¬ì„± ìš”ì†Œ ì •ë¦¬

ì‹¤ì œë¡œëŠ” ì•„ë˜ 3ê°€ì§€ê°€ ìˆë‹¤ê³  ë³´ë©´ ëœë‹¤.

1. **Git + `supabase/migrations` í´ë”**
    - ìŠ¤í‚¤ë§ˆ/í•¨ìˆ˜/RLS ì •ì˜ì˜ â€œì†ŒìŠ¤ ì½”ë“œâ€
    - ì§„ì§œ Source of Truth

2. **ë¡œì»¬ Supabase DB**
    - `supabase/db` ì•„ë˜ ë„ì»¤ ê¸°ë°˜ ê°œë°œìš© DB
    - `supabase db reset`, `supabase db push --local` ëŒ€ìƒ

3. **ë³¸ ì„œë²„(í˜¸ìŠ¤íŒ…) Supabase í”„ë¡œì íŠ¸ DB**
    - ì‹¤ì œ ì„œë¹„ìŠ¤ê°€ ë°”ë¼ë³´ëŠ” í”„ë¡œë•ì…˜(or ìŠ¤í…Œì´ì§•) DB
    - `supabase db push` (â€» `--local` ì—†ìŒ) ëŒ€ìƒ

ìš°ë¦¬ê°€ ì›í•˜ëŠ” ê²ƒì€:

> **1 â†’ 2 â†’ (í…ŒìŠ¤íŠ¸) â†’ 3**  
> ì´ í”Œë¡œìš°ë¥¼ í•­ìƒ **ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œ** ìœ ì§€í•˜ëŠ” ê²ƒ.

---

## 1. ìƒˆ ê¸°ëŠ¥/ë³€ê²½ì„ ì¶”ê°€í•  ë•Œì˜ ê¶Œì¥ FLOW

### 1ë‹¨ê³„) ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ë§Œë“¤ê¸°

ì˜ˆ: `ec.create_coupon` í•¨ìˆ˜/í…Œì´ë¸”ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì¶”ê°€í•˜ê³  ì‹¶ì„ ë•Œ.

```bash
supabase migration new add_coupon_function
```
ìœ„ ëª…ë ¹ì„ ì‹¤í–‰í•˜ë©´:

supabase/migrations/xxxx_add_coupon_function.sql
í˜•íƒœì˜ íŒŒì¼ì´ ìƒì„±ëœë‹¤.

ì´ íŒŒì¼ ì•ˆì— ì§ì ‘ SQLì„ ì‘ì„±í•œë‹¤:

> ğŸ’¡ Supabase Studio SQL EditorëŠ” â€œì´ˆì•ˆ í…ŒìŠ¤íŠ¸ìš©â€ ì •ë„ë¡œë§Œ ì“°ê³ ,
ìµœì¢…ë³¸ì€ ë°˜ë“œì‹œ ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì— ì˜®ê²¨ ì ëŠ”ë‹¤ê³  ìƒê°í•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤.

### 2ë‹¨ê³„) ë¡œì»¬ DBì— ì ìš© (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
ì „ì²´ ë¦¬ì…‹ í›„ ë‹¤ì‹œ ì ìš©í•˜ê³  ì‹¶ì„ ë•Œ
```bash
supabase db reset
```
ë¡œì»¬ DBë¥¼ ë“œë í›„ ì¬ìƒì„±í•œë‹¤.

supabase/migrationsì— ìˆëŠ” ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ 0ë¶€í„° ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ ì ìš©í•œë‹¤.
---

ì´ˆê¸°í™” ì—†ì´ ë³€ê²½ë¶„ë§Œ ì ìš©í•˜ê³  ì‹¶ì„ ë•Œ
```bash
supabase db push --local
```
ë¡œì»¬ DB ìƒíƒœì™€ supabase/migrationsë¥¼ ë¹„êµí•´
ì•„ì§ ì ìš©ë˜ì§€ ì•Šì€ ë§ˆì´ê·¸ë ˆì´ì…˜ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì ìš©í•œë‹¤.

ì´ ë‹¨ê³„ê¹Œì§€ ëë‚˜ë©´:

ë¡œì»¬ Supabase(Postgres ì»¨í…Œì´ë„ˆ)ì—
ë°©ê¸ˆ ì‘ì„±í•œ SQLì„ í¬í•¨í•œ ì „ì²´ ìŠ¤í‚¤ë§ˆê°€ ë“¤ì–´ê°€ê³ ,

Next.js admin-app, customer-appì„ ë¡œì»¬ì—ì„œ ë„ì›Œ

ìƒˆ í…Œì´ë¸”/í•¨ìˆ˜/RLSê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€,
ì•±ì—ì„œ ì—ëŸ¬ ì—†ì´ ì˜ ë¶™ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤.

### 3ë‹¨ê³„) Gitì— ì»¤ë°‹
ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì •ìƒ ì‘ë™í•˜ëŠ” ê²ƒì´ í™•ì¸ë˜ë©´, í•´ë‹¹ íŒŒì¼ì„ Gitì— ì»¤ë°‹í•œë‹¤.
```bash
git add supabase/migrations/xxxx_add_coupon_function.sql
git commit -m "feat(db): add ec.create_coupon function"
```
ì´ì œ ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì€:
íŒ€ì›ë“¤, ë‹¤ë¥¸ í™˜ê²½, ë¯¸ë˜ì˜ ë‚˜ê¹Œì§€ í¬í•¨í•´ì„œ
ê³µí†µ ê¸°ì¤€ì´ ë˜ëŠ” DB ë³€ê²½ ì´ë ¥ì´ ëœë‹¤.

### 4ë‹¨ê³„) ë³¸ ì„œë²„ Supabaseì— ë°°í¬
ë¡œì»¬ì—ì„œ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸í–ˆê³ ,
â€œì´ì œ í”„ë¡œë•ì…˜(ë˜ëŠ” ìŠ¤í…Œì´ì§•) DBì—ë„ ì ìš©í•˜ê² ë‹¤â€ë¼ê³  ê²°ì •í•˜ë©´:

ë¨¼ì € í”„ë¡œì íŠ¸ê°€ ì˜¬ë°”ë¥¸ ì›ê²© í”„ë¡œì íŠ¸ì— link ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

```bash
npm run supa:login
npm run supa:link

supabase db push
#  â†‘ ì—¬ê¸°ì—ëŠ” --local ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤!
#    ì´ ëª…ë ¹ì´ í˜¸ìŠ¤íŒ… Supabase(ë³¸ ì„œë²„)ë¡œ ë“¤ì–´ê°€ëŠ” ê²ƒ
```
ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ ì°¨ë¡€ëŒ€ë¡œ í•´ë‚˜ê°„ë‹¤.


ì´ ê³¼ì •ì„ ê±°ì¹˜ë©´:

ë¡œì»¬ DBì™€ ë³¸ ì„œë²„ DB ëª¨ë‘
Gitì— ìˆëŠ” ë™ì¼í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„¸íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë™ì‘í•œë‹¤.

> ë‚˜ì¤‘ì— ë¬¸ì œ ë°œìƒ ì‹œ
â€œì–´ëŠ ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ì—ì„œ ê¹¨ì¡ŒëŠ”ì§€â€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¶”ì í•  ìˆ˜ ìˆë‹¤.

```bash
supabase migration repair [ë²„ì „] --status applied
```


# Supabase Studio ì‚¬ìš© ì‹œ ì›ì¹™
Studio(SQL Editor, Table Editor ë“±)ëŠ” **â€œì‹¤í—˜ìš©/ì´ˆì•ˆ ì‘ì„±ìš©â€**ìœ¼ë¡œë§Œ ì‚¬ìš©.

ìµœì¢…ì ìœ¼ë¡œëŠ” í•­ìƒ: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì— SQL ì‘ì„±

supabase db reset / supabase db push --localë¡œ ì¬ì ìš©
ë¬¸ì œ ì—†ìœ¼ë©´ Git ì»¤ë°‹

supabase db pushë¡œ ë³¸ ì„œë²„ ì ìš©
ì´ ë£¨í‹´ì„ ìœ ì§€í•˜ë©´:
â€œë³¸ ì„œë²„ì—ì„œ ì§ì ‘ í…Œì´ë¸”/ì»¬ëŸ¼/í•¨ìˆ˜ ìˆ˜ì •í•´ë²„ë¦¬ê³ ,
ë‚˜ì¤‘ì— ë¡œì»¬ê³¼ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ê¼¬ì´ëŠ” ìƒí™©â€ì„ ë§‰ì„ ìˆ˜ ìˆë‹¤.

DB ìŠ¤í‚¤ë§ˆê°€ ì»¤ì ¸ë„,
ë³€ê²½ ì´ë ¥ì„ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ + Git ë¡œê·¸ë¡œ ê¹”ë”í•˜ê²Œ ì¶”ì  ê°€ëŠ¥.

# ìŠ¤íŒŒë² ì´ìŠ¤ ì´ë ¥ ì €ì¥ í•˜ê¸° 
í˜„ì¬ local / remote migration ìƒíƒœ í™•ì¸
```bash
supabase migration list --linked
```
```bash
supabase migration repair 20251129190555 --status applied
```
ì™€ ê°™ì€ ì´ë ¥ì„ ì €ì¥ í•˜ë©´ ì €ì¥ì´ ëœë‹¤.